/******************************************************************************

 * * Filename: 		main.c
 * * Description: 	Traffic light for pedestrian
 * * 
 * * Version: 		1.0
 * * Created:		2014/01/16
 * * Revision:		2014/01/19
 * * Compiler: 		gcc
 * *
 * * Author: 		Wayne
 * * Organization:	CoDesign 

 ******************************************************************************/

/******************************
 *	Ports Usage:              *
 *	P0 for Green              *
 *	P10 ~ P13 for 7-segs      *
 *	P2 for Red                *
 *	P30 ~ P33 for row select  *
 ******************************/
#pragma COMPACT
#include <REG_MPC82G516.H>
#define uchar unsigned char
#define GREEN 0
#define RED 1
#define SETUP 0
#define TRAFFIC 1

sbit D1 = P1^4;		// lower section
sbit D2 = P1^5;		// upper section
sbit SET = P1^7;
sbit INC = P3^4;
sbit DEC = P3^5;
sbit S1 = P3^6;		// lower digit
sbit S2 = P3^7;		// upper digit

static uchar overflow_count = 0;	// 20 for 1 sec
static uchar display_color = GREEN;
static uchar mode = SETUP;
static int green_time = 0;
static int red_time = 0;
static int green_time_set = 0;
static int red_time_set = 0;
char num;
char pic_select = 0;

char red_man_upper[16] =
{
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	000+00+32+16+8+4+2+1,
	000+00+00+16+8+4+2+1,
	128+00+00+00+8+4+2+1,
	000+00+00+00+0+0+0+0,
	000+00+00+00+8+0+0+0,
	
	000+00+00+00+0+0+0+0,
	128+00+00+00+8+4+2+1,
	000+00+00+16+8+4+2+1,
	000+00+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1
};

char red_man_lower[16] =
{
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	000+64+32+16+8+0+0+0,
	000+00+32+16+8+4+0+0,
	000+00+00+00+0+0+2+1,
	000+00+00+00+0+0+0+0,
	128+64+32+16+8+0+0+0,
	
	000+00+00+00+0+0+0+0,
	000+00+00+00+0+0+2+1,
	000+00+32+16+8+4+0+0,
	000+64+32+16+8+0+0+0,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1
};

char green_man_upper[6][16] =	// max 7
{
	// pic0
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+0+2+1,
	000+64+32+16+0+0+0+1,
	000+00+00+00+0+0+0+1,
	000+00+00+00+8+0+2+1,
	000+00+00+16+8+4+2+1,
	
	128+64+00+16+8+4+2+1,
	128+00+32+16+8+4+2+1,
	000+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	
	// pic2
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+0+2+1,
	128+64+32+16+0+0+0+1,
	000+00+00+00+0+0+0+1,
	000+00+00+00+8+0+2+1,
	000+00+00+16+8+4+2+1,
	
	128+64+00+16+8+4+2+1,
	128+64+00+16+8+4+2+1,
	128+00+32+16+8+4+2+1,
	000+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	
	// pic3
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+0+2+1,
	128+64+32+16+0+0+0+1,
	000+00+00+00+0+0+0+1,
	000+00+00+00+8+0+2+1,
	000+64+00+16+8+4+2+1,
	
	128+64+00+16+8+4+2+1,
	128+00+32+16+8+4+2+1,
	000+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	
	// pic5
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+0+2+1,
	128+64+32+16+0+0+0+1,
	128+00+00+00+0+0+0+1,
	000+00+00+00+8+0+2+1,
	000+64+00+16+8+4+2+1,
	
	128+00+32+16+8+4+2+1,
	000+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	
	// pic6
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+0+2+1,
	128+64+32+16+0+0+0+1,
	128+00+00+00+0+0+0+1,
	000+00+00+00+8+0+2+1,
	000+64+00+16+8+4+2+1,
	
	128+00+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	
	// pic8
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+0+2+1,
	000+64+32+16+0+0+0+1,
	000+64+00+00+0+0+0+1,
	000+00+00+00+8+0+2+1,
	000+00+00+16+8+4+2+1,
	
	000+00+00+16+8+4+2+1,
	000+00+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1
};

char green_man_lower[6][16] =
{
	// pic0
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+00+16+8+4+2+0,
	128+64+00+16+8+4+2+1,
	128+64+32+00+8+4+2+1,
	128+64+32+16+0+4+2+1,
	128+64+32+16+8+0+0+0,
	
	128+64+32+16+8+4+0+0,
	128+64+32+16+8+0+2+1,
	128+64+32+16+0+4+2+0,
	128+64+32+00+8+4+2+1,
	128+00+00+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	
	// pic2
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+00+32+16+8+4+2+1,
	128+00+32+16+8+4+2+0,
	128+00+32+16+8+4+2+1,
	128+64+00+00+0+4+2+1,
	128+64+32+16+8+0+0+0,
	
	128+64+32+16+8+4+0+0,
	128+64+32+16+8+0+2+1,
	128+64+32+16+0+4+2+1,
	128+00+32+16+0+4+2+1,
	128+64+00+00+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	
	// pic3
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+00+32+16+8+4+2+0,
	128+00+32+00+0+4+2+1,
	128+00+00+16+8+0+2+1,
	128+64+32+16+8+4+0+0,
	
	128+64+32+16+8+4+0+0,
	128+64+00+16+0+0+2+1,
	128+64+00+16+0+4+2+0,
	128+64+32+00+0+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	
	// pic5
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	000+64+00+16+0+4+2+1,
	000+00+00+16+8+0+2+0,
	128+64+32+16+8+0+0+0,
	
	128+64+32+16+0+0+0+1,
	128+64+32+00+8+4+2+0,
	128+64+32+00+8+4+2+1,
	128+00+00+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	
	// pic6
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	000+64+32+00+0+4+2+1,
	000+64+00+16+8+0+2+0,
	000+00+00+16+8+0+0+0,
	128+64+32+16+0+0+0+0,
	
	128+64+32+00+8+4+2+1,
	128+00+00+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	
	// pic8
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+00+32+16+8+4+2+1,
	128+00+32+00+8+4+2+1,
	128+00+00+00+0+4+2+1,
	128+64+32+16+8+0+0+0,
	128+64+32+00+0+0+0+0,
	
	000+00+32+00+0+0+0+0,
	000+00+00+16+8+4+2+1,
	000+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1,
	128+64+32+16+8+4+2+1
};

void init();
void reset();
void set_time();
void timer();
void inc_time();
void dec_time();
void display_time();
void display_move();
void delay(int ms);
void delay_us(int us);

void main()
{
	init();
	reset();
	while(1) {
		mode = TRAFFIC;
		display_move();
		if(SET == 0) {
			delay(100);
			if(SET == 0) {
				reset();
				while(SET == 0) {
					display_move();
				}
			}
		}
	}
}

void init()
{
	TMOD = 1;			// timer 0, mode 1 (8-bit TL0, 8-bit TH0)
	IE = 0x82;			// 10000010, timer 0 overflow generates interrupt
	TCON = 0x02;		// 00000010

	TH0 = (65536-50000) / 256;	// 50000ms
	TL0 = (65536-50000) % 256;
	TR0 = 0;			// stop timing
	//TR0 = 1;			// start timing
	P0 = 0xFF;
	P1 = 0xFF;
	P2 = 0xFF;
	P3 = 0xFF;
}

void reset()
{
	TR0 = 0;			// stop timing
	mode = SETUP;
	// set green_time
	display_color = GREEN;
	green_time = 0;
	set_time();
	green_time_set = green_time;
	// set red_time
	display_color = RED;
	red_time = 0;
	set_time();
	red_time_set = red_time;
	// end setting
	TR0 = 1;			// start timing
}

void set_time()
{
	while(1) {
		//display_time();
		display_move();
		if(INC == 0 && DEC == 1) {		// increase
			inc_time();
			delay(500);
			while(INC == 0) {
				display_move();
			}
		}
		else if(INC == 1 && DEC == 0) {	// decrease
			dec_time();
			delay(500);
			while(DEC == 0) {
				display_move();
			}
		}
		if(SET == 0) {
			delay(500);
			if(SET == 0) {
				if(display_color == GREEN && green_time != 0) break;
				if(display_color == RED && red_time != 0) break;
				while(SET == 0) {
					display_move();
				}
			}
		}
	}
}

void timer() interrupt 1		//interrupt 1 for Timer 0
{
	TF0 = 0;					// reset the overlfow flag
	if(overflow_count == 19) {
		// time decrease
		dec_time();
		// set overflow_count to 0
		overflow_count = 0;
	}
	else {
		overflow_count++;
	}
	if(display_color == GREEN && green_time < 10 && (overflow_count%5) == 0) {
		if(pic_select < 4) pic_select++;
		else pic_select = 0;
	}
	else if(display_color == GREEN && overflow_count == 0) {
		if(pic_select < 4) pic_select++;
		else pic_select = 0;
	}
	TH0 = (65536-50000) / 256;	// 50000ms
	TL0 = (65536-50000) % 256;
	TR0 = 1;
}

void inc_time()
{
	if(display_color == GREEN) {
		if(green_time < 99)
			green_time++;
	}
	else if(display_color == RED) {
		if(red_time < 99)
			red_time++;
	}
}

void dec_time()
{
	if(display_color == GREEN) {
		if(green_time > 1)
			green_time--;
		else if(mode == TRAFFIC) {
			display_color = RED;
			green_time = green_time_set;
		}
	}
	else if(display_color == RED) {
		if(red_time > 1)
			red_time--;
		else if(mode == TRAFFIC) {
			display_color = GREEN;
			red_time = red_time_set;
		}
	}
}

void display_time()
{
	// lower digit
	S1 = 0;
	S2 = 1;
	if(display_color == GREEN) {
		num = green_time % 10;
	}
	else {
		num = red_time % 10;
	}
	P10 = num%2;
	P11 = num/2%2;
	P12 = num/4%2;
	P13 = num/8%2;
	delay_us(200);
	// higher digit
	S1 = 1;
	S2 = 0;
	if(display_color == GREEN) {
		num = green_time / 10;
	}
	else {
		num = red_time / 10;
	}
	P10 = num%2;
	P11 = num/2%2;
	P12 = num/4%2;
	P13 = num/8%2;
	if(num == 0) P1 |= 0x0F;
	delay_us(200);
}

void display_move()
{
	int i;
	for(i = 0; i < 16; i++) {
		display_time();
		// select row
		P30 = i%2;
		P31 = i/2%2;
		P32 = i/4%2;
		P33 = i/8%2;
		
		D1 = 0;
		D2 = 1;
		if(display_color == GREEN) {
			P0 = 0xFF;
			P2 = green_man_lower[pic_select][i];
		}
		else if(display_color == RED) {
			P0 = red_man_lower[i];
			P2 = 0xFF;
		}
		delay_us(5);
		
		D1 = 1;
		D2 = 0;
		if(display_color == GREEN) {
			P0 = 0xFF;
			P2 = green_man_upper[pic_select][i];
		}
		else if(display_color == RED) {
			P0 = red_man_upper[i];
			P2 = 0xFF;
		}
		delay_us(5);
	}
}

void delay(int ms)
{
	int i;
	while(ms--);
		for(i = 0; i < 1000; i++);
}

void delay_us(int us)
{
	while(us--);
}